name: Deploy SBM Analyzer

on:
  push:
    branches:
      - main

jobs:
  deploy-analyzer:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. æˆæœç‰©ã‚’EC2ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy code to EC2
        uses: burnett01/rsync-deployments@5.1
        with:
          switches: '-avz --delete --rsync-path="sudo rsync"'
          path: ./ # ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹
          remote_path: /srv/sbm/analyzer/ # EC2ã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USER }}
          remote_key: ${{ secrets.SECRET_KEY }}

      # 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
      - name: Create backup
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            cd /srv/sbm/analyzer
            if [ -d "current" ]; then
              echo "ğŸ“¦ ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
              cp -r current backup_$(date +%Y%m%d_%H%M%S)
            fi

      # 4. æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy new code
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            cd /srv/sbm/analyzer
            echo "ğŸ“¥ æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
            cp -r . current/

      # 5. Conda ç’°å¢ƒã§ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Set up Python environment and install dependencies
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            cd /srv/sbm/analyzer
            # condaç’°å¢ƒã®å­˜åœ¨ç¢ºèª
            if ! conda env list | grep -q "sbm-analyzer"; then
              echo "âŒ sbm-analyzerç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ç’°å¢ƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"
              exit 1
            fi
            source ~/miniconda3/bin/activate
            conda activate sbm-analyzer
            # Pythonãƒ‘ã‚¹ã®ç¢ºèª
            which python
            python --version
            pip install --upgrade pip
            pip install -r requirements.txt

      # 6. .env ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
      - name: Generate .env file
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            cd /srv/sbm/analyzer
            sudo chmod 777 /srv/sbm/analyzer/
            # .envãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            if [ ! -f ".env" ]; then
              cat > .env << EOF
              ENVIRONMENT=prod
              DB_USER=${{ secrets.DB_USER }}
              DB_PASSWORD=${{ secrets.DB_PASSWORD }}
              DB_HOST=${{ secrets.DB_HOST }}
              DB_PORT=${{ secrets.DB_PORT }}
              DB_NAME=${{ secrets.DB_NAME }}
              FLASK_ENV=production
              FLASK_DEBUG=False
              SECRET_KEY=${{ secrets.SECRET_KEY }}
              LOG_LEVEL=INFO
              EOF
            else
              # æ—¢å­˜ã®.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
              sed -i "s|ENVIRONMENT=.*|ENVIRONMENT=prod|" .env
              sed -i "s|DB_USER=.*|DB_USER=${{ secrets.DB_USER }}|" .env
              sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=${{ secrets.DB_PASSWORD }}|" .env
              sed -i "s|DB_HOST=.*|DB_HOST=${{ secrets.DB_HOST }}|" .env
              sed -i "s|DB_PORT=.*|DB_PORT=${{ secrets.DB_PORT }}|" .env
              sed -i "s|DB_NAME=.*|DB_NAME=${{ secrets.DB_NAME }}|" .env
              sed -i "s|FLASK_ENV=.*|FLASK_ENV=production|" .env
              sed -i "s|FLASK_DEBUG=.*|FLASK_DEBUG=False|" .env
              sed -i "s|SECRET_KEY=.*|SECRET_KEY=${{ secrets.SECRET_KEY }}|" .env
              sed -i "s|LOG_LEVEL=.*|LOG_LEVEL=INFO|" .env
            fi
            sudo chmod 755 /srv/sbm/analyzer/
            sudo chown -R ubuntu:ubuntu /srv/sbm/analyzer/

      # 7. ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      - name: Create systemd service file
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            sudo tee /etc/systemd/system/sbm-analyzer.service > /dev/null << 'EOF'
            [Unit]
            Description=SBM Analyzer Flask Application
            After=network.target

            [Service]
            Type=simple
            User=ubuntu
            Group=ubuntu
            WorkingDirectory=/srv/sbm/analyzer
            Environment=PATH=/home/ubuntu/miniconda3/envs/sbm-analyzer/bin:/home/ubuntu/miniconda3/bin
            Environment=CONDA_DEFAULT_ENV=sbm-analyzer
            ExecStart=/home/ubuntu/miniconda3/envs/sbm-analyzer/bin/python run.py
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            EOF

      # 8. ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹åŒ–ã—ã¦å†èµ·å‹•
      - name: Enable and restart service
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            sudo systemctl daemon-reload
            sudo systemctl enable sbm-analyzer
            sudo systemctl restart sbm-analyzer

      # 9. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Health check
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            echo "ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
            sleep 15
            if curl -f http://localhost:5001/api/v1/health > /dev/null 2>&1; then
              echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
              sudo systemctl status sbm-analyzer
            else
              echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
              sudo journalctl -u sbm-analyzer -n 50
              exit 1
            fi

      # 10. å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ30æ—¥ä»¥ä¸Šå¤ã„ã‚‚ã®ï¼‰
      - name: Cleanup old backups
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET_KEY }}
          script: |
            cd /srv/sbm/analyzer
            find . -name "backup_*" -type d -mtime +30 -exec rm -rf {} \;
            echo "ğŸ§¹ å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
